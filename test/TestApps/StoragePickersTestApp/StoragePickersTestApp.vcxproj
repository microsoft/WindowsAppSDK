<?xml version="1.0" encoding="utf-8"?>
<!-- Copyright (c) Microsoft Corporation.
     Licensed under the MIT License. -->
<Project ToolsVersion="15.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- PropertyGroup Label="Globals" MUST come BEFORE the imports for WinUI XAML processing to work -->
  <PropertyGroup Label="Globals">
    <VCProjectVersion>16.0</VCProjectVersion>
    <Keyword>Win32Proj</Keyword>
    <ProjectGuid>{C0C88F67-8C6C-49F8-827E-86C0E1669F09}</ProjectGuid>
    <RootNamespace>StoragePickersTestApp</RootNamespace>
    <TargetName>$(RootNamespace)</TargetName>
    <DefaultLanguage>en-US</DefaultLanguage>
    <MinimumVisualStudioVersion>16.0</MinimumVisualStudioVersion>
    <WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>
    <WindowsTargetPlatformMinVersion>10.0.17763.0</WindowsTargetPlatformMinVersion>
    <AppContainerApplication>false</AppContainerApplication>
    <!-- Unpackaged app - uses bootstrap to load installed Windows App SDK runtime -->
    <AppxPackage>false</AppxPackage>
    <ApplicationType>Windows Store</ApplicationType>
    <ApplicationTypeRevision>10.0</ApplicationTypeRevision>
    <!-- WinUI settings - CRITICAL: These must be set before imports -->
    <UseWinUI>true</UseWinUI>
    <WinUISDKReferences>false</WinUISDKReferences>
    <EnableMsixTooling>true</EnableMsixTooling>
    <!-- C++/WinRT settings -->
    <CppWinRTOptimized>true</CppWinRTOptimized>
    <CppWinRTRootNamespaceAutoMerge>true</CppWinRTRootNamespaceAutoMerge>
    <MinimalCoreWin>true</MinimalCoreWin>
    <!-- Tell XAML compiler to generate C++/WinRT code, not C++/CX -->
    <XamlLanguage>CppWinRT</XamlLanguage>
    <!-- Disable legacy /await flag - use C++20 coroutines instead -->
    <CppWinRTEnableLegacyCoroutines>false</CppWinRTEnableLegacyCoroutines>
    <!-- Unpackaged app mode - bootstrap auto-initialize will load the installed WinAppSDK runtime -->
    <WindowsAppSDKSelfContained>false</WindowsAppSDKSelfContained>
    <!-- Force bootstrap initialization (lowercase 'd' in Sdk is correct) -->
    <WindowsAppSdkBootstrapInitialize>true</WindowsAppSdkBootstrapInitialize>
    <WindowsAppSDKBootstrapAutoInitializeOptions_OnError_DebugBreak_IfDebuggerAttached>true</WindowsAppSDKBootstrapAutoInitializeOptions_OnError_DebugBreak_IfDebuggerAttached>
    <!-- PRI configuration for unpackaged app - resources should be in root namespace -->
    <PrependPriInitialPath>false</PrependPriInitialPath>
    <PriIndexName></PriIndexName>
    <!-- Skip portable library PRI generation (not needed for unpackaged app) -->
    <AppxGeneratePrisForPortableLibrariesEnabled>false</AppxGeneratePrisForPortableLibrariesEnabled>
    <!-- Disable MRT Core DLL copy - we use the local build output instead -->
    <_AddMrtCoreAssembliesToReferenceCopyLocalPaths>false</_AddMrtCoreAssembliesToReferenceCopyLocalPaths>
    <!-- Bypass the CustomBeforeMicrosoftCommonTargets check - we manually import the required files -->
    <_IsWinUICustomBeforeMicrosoftCommonTargetsChainValid>true</_IsWinUICustomBeforeMicrosoftCommonTargetsChainValid>
    <!-- Force WinUI tools (from NuGet), not UWP tools (from SDK) - this fake path prevents SDK XAML compiler from being found -->
    <UseWinUITools>true</UseWinUITools>
    <WindowsKitsPath>WinUI-Projects-Don-t-Use-SDK-Xaml-Tools</WindowsKitsPath>
  </PropertyGroup>

  <!-- Provide stub for _AddUnionWinmd target that NuGet packaging expects -->
  <Target Name="_AddUnionWinmd" />
  
  <!-- Skip portable library PRI generation which requires parameters we don't have -->
  <Target Name="_GeneratePrisForPortableLibraries" />

  <!-- Import WinUI MSIX props that normally would be imported via CustomBeforeMicrosoftCommonTargets -->
  <Import Project="$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\Microsoft.Build.Msix.props" Condition="Exists('$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\Microsoft.Build.Msix.props')" />

  <!-- WindowsAppSDK props must be imported BEFORE Microsoft.Cpp.Default.props -->
  <Import Project="$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.props" Condition="Exists('$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.props')" />
  <Import Project="$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.props" Condition="Exists('$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.props')" />

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />

  <ItemGroup Label="ProjectConfigurations">
    <ProjectConfiguration Include="Debug|Win32">
      <Configuration>Debug</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|Win32">
      <Configuration>Release</Configuration>
      <Platform>Win32</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|x64">
      <Configuration>Debug</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|x64">
      <Configuration>Release</Configuration>
      <Platform>x64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Debug|ARM64">
      <Configuration>Debug</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
    <ProjectConfiguration Include="Release|ARM64">
      <Configuration>Release</Configuration>
      <Platform>ARM64</Platform>
    </ProjectConfiguration>
  </ItemGroup>

  <PropertyGroup Label="Configuration">
    <ConfigurationType>Application</ConfigurationType>
    <PlatformToolset>v143</PlatformToolset>
    <CharacterSet>Unicode</CharacterSet>
    <DesktopCompatible>true</DesktopCompatible>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='Debug'" Label="Configuration">
    <UseDebugLibraries>true</UseDebugLibraries>
    <LinkIncremental>true</LinkIncremental>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='Release'" Label="Configuration">
    <UseDebugLibraries>false</UseDebugLibraries>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <LinkIncremental>false</LinkIncremental>
  </PropertyGroup>

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />

  <ImportGroup Label="ExtensionSettings">
  </ImportGroup>

  <ImportGroup Label="PropertySheets">
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
  </ImportGroup>

  <PropertyGroup Label="UserMacros" />

  <!-- Platform-specific SDK path -->
  <PropertyGroup>
    <_WindowsAppSDKFoundationPlatform Condition="'$(Platform)' == 'Win32'">x86</_WindowsAppSDKFoundationPlatform>
    <_WindowsAppSDKFoundationPlatform Condition="'$(Platform)' != 'Win32'">$(Platform)</_WindowsAppSDKFoundationPlatform>
  </PropertyGroup>
  
  <ItemDefinitionGroup>
    <ClCompile>
      <PrecompiledHeader>Use</PrecompiledHeader>
      <PrecompiledHeaderFile>pch.h</PrecompiledHeaderFile>
      <PrecompiledHeaderOutputFile>$(IntDir)pch.pch</PrecompiledHeaderOutputFile>
      <WarningLevel>Level4</WarningLevel>
      <LanguageStandard>stdcpp17</LanguageStandard>
      <AdditionalOptions>%(AdditionalOptions) /bigobj</AdditionalOptions>
      <AdditionalIncludeDirectories>$(RepoRoot)\dev\common;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
    </ClCompile>
    <!-- Manually add Bootstrap library for unpackaged app support -->
    <Link>
      <AdditionalDependencies>%(AdditionalDependencies);$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\lib\win10-$(_WindowsAppSDKFoundationPlatform)\Microsoft.WindowsAppRuntime.Bootstrap.lib</AdditionalDependencies>
    </Link>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='Debug'">
    <ClCompile>
      <PreprocessorDefinitions>_DEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    </ClCompile>
  </ItemDefinitionGroup>
  <ItemDefinitionGroup Condition="'$(Configuration)'=='Release'">
    <ClCompile>
      <PreprocessorDefinitions>NDEBUG;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    </ClCompile>
    <Link>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
    </Link>
  </ItemDefinitionGroup>

  <!-- XAML files must be defined BEFORE the targets are imported -->
  <ItemGroup>
    <AppxManifest Include="Package.appxmanifest">
      <SubType>Designer</SubType>
    </AppxManifest>
  </ItemGroup>
  <ItemGroup>
    <Manifest Include="app.manifest" />
  </ItemGroup>
  <ItemGroup>
    <ClInclude Include="pch.h" />
    <ClInclude Include="App.xaml.h">
      <DependentUpon>App.xaml</DependentUpon>
    </ClInclude>
    <ClInclude Include="MainWindow.xaml.h">
      <DependentUpon>MainWindow.xaml</DependentUpon>
    </ClInclude>
  </ItemGroup>
  <ItemGroup>
    <ApplicationDefinition Include="App.xaml" />
    <Page Include="MainWindow.xaml" />
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="pch.cpp">
      <PrecompiledHeader>Create</PrecompiledHeader>
    </ClCompile>
    <ClCompile Include="App.xaml.cpp">
      <DependentUpon>App.xaml</DependentUpon>
    </ClCompile>
    <ClCompile Include="MainWindow.xaml.cpp">
      <DependentUpon>MainWindow.xaml</DependentUpon>
    </ClCompile>
    <ClCompile Include="$(GeneratedFilesDir)module.g.cpp" />
  </ItemGroup>
  <ItemGroup>
    <Midl Include="MainWindow.idl">
      <SubType>Code</SubType>
      <DependentUpon>MainWindow.xaml</DependentUpon>
    </Midl>
  </ItemGroup>
  <ItemGroup>
    <Image Include="Assets\LockScreenLogo.scale-200.png" />
    <Image Include="Assets\SplashScreen.scale-200.png" />
    <Image Include="Assets\Square150x150Logo.scale-200.png" />
    <Image Include="Assets\Square44x44Logo.scale-200.png" />
    <Image Include="Assets\Square44x44Logo.targetsize-24_altform-unplated.png" />
    <Image Include="Assets\StoreLogo.png" />
    <Image Include="Assets\Wide310x150Logo.scale-200.png" />
  </ItemGroup>
  <ItemGroup>
    <None Include="packages.config" />
  </ItemGroup>

  <!-- WebView2 reference needed by WinUI -->
  <ItemGroup>
    <Reference Include="Microsoft.Web.WebView2.Core">
      <HintPath>$(NugetPackageDirectory)\Microsoft.Web.WebView2.1.0.2651.64\lib\Microsoft.Web.WebView2.Core.winmd</HintPath>
      <IsWinMDFile>true</IsWinMDFile>
    </Reference>
  </ItemGroup>

  <!-- Project Reference to ensure WindowsAppRuntime_DLL is built before this project (for the local Storage.Pickers winmd) -->
  <ItemGroup>
    <ProjectReference Include="..\..\..\dev\WindowsAppRuntime_DLL\WindowsAppRuntime_DLL.vcxproj">
      <Project>{B73AD907-6164-4294-88FB-F3C9C10DA1F1}</Project>
      <ReferenceOutputAssembly>false</ReferenceOutputAssembly>
      <Private>false</Private>
    </ProjectReference>
  </ItemGroup>

  <!-- Defining the "Msix" ProjectCapability here allows the Single-project MSIX Packaging
       Tools extension to be activated for this project even if the Windows App SDK Nuget
       package has not yet been restored. -->
  <ItemGroup Condition="'$(DisableMsixProjectCapabilityAddedByProject)'!='true' and '$(EnableMsixTooling)'=='true'">
    <ProjectCapability Include="Msix"/>
  </ItemGroup>

  <PropertyGroup Condition="'$(DisableHasPackageAndPublishMenuAddedByProject)'!='true' and '$(EnableMsixTooling)'=='true'">
    <HasPackageAndPublishMenu>true</HasPackageAndPublishMenu>
  </PropertyGroup>

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />

  <!-- Fix CppWinRTPath before importing CppWinRT.targets - the targets file has a bug with backslash escaping quotes -->
  <PropertyGroup>
    <CppWinRTPath Condition="'$(CppWinRTPath)' == ''">&quot;$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\bin&quot;\</CppWinRTPath>
  </PropertyGroup>

  <ImportGroup Label="ExtensionTargets">
    <Import Project="$(NugetPackageDirectory)\Microsoft.Web.WebView2.1.0.2651.64\build\native\Microsoft.Web.WebView2.targets" Condition="Exists('$(NugetPackageDirectory)\Microsoft.Web.WebView2.1.0.2651.64\build\native\Microsoft.Web.WebView2.targets')" />
    <Import Project="$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.targets" Condition="Exists('$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.targets')" />
    <Import Project="$(NugetPackageDirectory)\Microsoft.Windows.ImplementationLibrary.$(MicrosoftWindowsImplementationLibraryVersion)\build\native\Microsoft.Windows.ImplementationLibrary.targets" Condition="Exists('$(NugetPackageDirectory)\Microsoft.Windows.ImplementationLibrary.$(MicrosoftWindowsImplementationLibraryVersion)\build\native\Microsoft.Windows.ImplementationLibrary.targets')" />
    <Import Project="$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.targets" Condition="Exists('$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.targets')" />
    <Import Project="$(NugetPackageDirectory)\Microsoft.Windows.SDK.BuildTools.$(MicrosoftWindowsSDKBuildToolsVersion)\build\Microsoft.Windows.SDK.BuildTools.targets" Condition="Exists('$(NugetPackageDirectory)\Microsoft.Windows.SDK.BuildTools.$(MicrosoftWindowsSDKBuildToolsVersion)\build\Microsoft.Windows.SDK.BuildTools.targets')" />
  </ImportGroup>

  <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
    <PropertyGroup>
      <ErrorText>This project references NuGet package(s) that are missing on this computer. Use NuGet Package Restore to download them.  For more information, see http://go.microsoft.com/fwlink/?LinkID=322105. The missing file is {0}.</ErrorText>
    </PropertyGroup>
    <Error Condition="!Exists('$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.props')" Text="$([System.String]::Format('$(ErrorText)', '$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.props'))" />
    <Error Condition="!Exists('$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(NugetPackageDirectory)\Microsoft.Windows.CppWinRT.$(MicrosoftWindowsCppWinRTVersion)\build\native\Microsoft.Windows.CppWinRT.targets'))" />
    <Error Condition="!Exists('$(NugetPackageDirectory)\Microsoft.Windows.ImplementationLibrary.$(MicrosoftWindowsImplementationLibraryVersion)\build\native\Microsoft.Windows.ImplementationLibrary.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(NugetPackageDirectory)\Microsoft.Windows.ImplementationLibrary.$(MicrosoftWindowsImplementationLibraryVersion)\build\native\Microsoft.Windows.ImplementationLibrary.targets'))" />
    <Error Condition="!Exists('$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.props')" Text="$([System.String]::Format('$(ErrorText)', '$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.props'))" />
    <Error Condition="!Exists('$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.targets')" Text="$([System.String]::Format('$(ErrorText)', '$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\build\native\Microsoft.WindowsAppSDK.targets'))" />
  </Target>

  <!-- Add a custom target to inject the local Storage.Pickers WinMD after CppWinRT's GetCppWinRTDirectWinMDReferences -->
  <PropertyGroup>
    <CppWinRTMakeReferenceProjectionDependsOn>$(CppWinRTMakeReferenceProjectionDependsOn);AddLocalStoragePickersWinMD</CppWinRTMakeReferenceProjectionDependsOn>
    <!-- Path to the local WindowsAppRuntime_DLL output -->
    <LocalWinMDPath>$(RepoRoot)\BuildOutput\$(Configuration)\$(Platform)\WindowsAppRuntime_DLL\Microsoft.Windows.Storage.Pickers.winmd</LocalWinMDPath>
  </PropertyGroup>
  <Target Name="AddLocalStoragePickersWinMD" BeforeTargets="CppWinRTMakeReferenceProjection" AfterTargets="CppWinRTResolveReferences">
    <ItemGroup>
      <CppWinRTDirectWinMDReferences Include="$(LocalWinMDPath)">
        <WinMDPath>$(LocalWinMDPath)</WinMDPath>
      </CppWinRTDirectWinMDReferences>
    </ItemGroup>
    <Message Text="Added local Storage.Pickers WinMD: $(LocalWinMDPath)" Importance="High" />
  </Target>

  <!-- Copy Bootstrap.dll for unpackaged app support -->
  <Target Name="CopyBootstrapDll" AfterTargets="AfterBuild">
    <Copy SkipUnchangedFiles="true" 
          SourceFiles="$(NugetPackageDirectory)\Microsoft.WindowsAppSDK.$(MicrosoftWindowsAppSDKVersion)\runtimes\win-$(_WindowsAppSDKFoundationPlatform)\native\Microsoft.WindowsAppRuntime.Bootstrap.dll"
          DestinationFolder="$(OutDir)" />
  </Target>

  <!-- Fix XAML code generator bug: remove self-referential XamlMetaDataProvider from OtherProviders -->
  <!-- The generated XamlTypeInfo.g.cpp incorrectly adds the app's own XamlMetaDataProvider to _otherProviders,
       causing infinite recursion during type lookup. This target removes that problematic line. -->
  <Target Name="FixXamlTypeInfoSelfReference" AfterTargets="MarkupCompilePass2" BeforeTargets="CompileXamlGeneratedFiles">
    <PropertyGroup>
      <XamlTypeInfoFile>$(GeneratedFilesDir)XamlTypeInfo.g.cpp</XamlTypeInfoFile>
    </PropertyGroup>
    <Exec Command="powershell -NoProfile -ExecutionPolicy Bypass -File &quot;$(ProjectDir)FixXamlTypeInfo.ps1&quot; -FilePath &quot;$(XamlTypeInfoFile)&quot;"
          Condition="Exists('$(XamlTypeInfoFile)')" />
  </Target>

  <!-- Copy the locally built WindowsAppRuntime DLL to override the NuGet package's version -->
  <!-- NOTE: This will cause issues if the local DLL is missing types that the installed SDK has.
       For testing local Storage.Pickers changes, you need to deploy the full local SDK build first.
       Uncomment the target below only after running deploy-local-sdk.ps1 or similar. -->
  <!--
  <Target Name="CopyLocalRuntimeFiles" AfterTargets="AfterBuild">
    <PropertyGroup>
      <LocalRuntimeDllPath>$(RepoRoot)\BuildOutput\$(Configuration)\$(Platform)\WindowsAppRuntime_DLL\Microsoft.WindowsAppRuntime.dll</LocalRuntimeDllPath>
    </PropertyGroup>
    <Copy SkipUnchangedFiles="true" SourceFiles="$(LocalRuntimeDllPath)" DestinationFolder="$(OutDir)" Condition="Exists('$(LocalRuntimeDllPath)')" />
  </Target>
  -->

</Project>
