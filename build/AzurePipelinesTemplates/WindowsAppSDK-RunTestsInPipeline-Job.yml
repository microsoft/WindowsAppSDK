# This runs the integration tests directly in the pipeline on the images hosted by the 'WinAppSDK-Test-Pool'.
# This pool is a 1ES Hosted Pool with custom images, which lets us run tests on builds beyond what is
# supported by Helix or the Azure DevOps Microsoft hosted agents. In case of arm64, we use the
# 'WinAppSDK-Test-Pool-Arm64' pool instead, and use parameter isArm64Platfrom to drive pool selection.

parameters:
- name: jobName
  type: string
  default: PipelineTests
- name: dependsOn
  type: object
  default:
  - ''
  # testMatrix is supplied by WindowsAppSDKConfig/WindowsAppSDK-Foundation-TestConfig.yml
- name: testMatrix
  type: object
  default: ''

jobs:
- job: ${{ parameters.jobName }}
  dependsOn: ${{ parameters.dependsOn }}
  strategy:
    # Debug/Release buildConfiguration below refers to the build of the tests/apps. The OS image bits are always Release build.
    matrix: ${{ parameters.testMatrix }}      # The test matrix for x64 is currently larger; this is where we exercise most variations.
  pool:
    type: windows
    isCustom: true
    name: $(poolName)
    demands: ImageOverride -equals $(imageName)
  timeoutInMinutes: 60
  variables:
    testPayloadArtifactDir: $(Build.SourcesDirectory)\BuildOutput\$(buildConfiguration)\$(buildPlatform)
  steps:
    - template: WindowsAppSDK-RunTests-Steps.yml
      parameters:
        buildPlatform: $(buildPlatform)
        buildConfiguration: $(buildConfiguration)
        testLocale: $(testLocale)
        ImageName: $(imageName)
