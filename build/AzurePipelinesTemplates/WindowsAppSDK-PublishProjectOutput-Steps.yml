parameters:
  artifactName: 'windowsappsdk_binaries'

steps:
  - script: |
      echo source: $(Build.SourcesDirectory)\BuildOutput\Release\$(buildPlatform)
      echo dest: $(Build.ArtifactStagingDirectory)\pushnotification_testbin\$(buildPlatform)\$(buildConfiguration)
      dir $(Build.ArtifactStagingDirectory) /s
    displayName: 'debug copy push notification tests'

  # Copy and Publish the test binaries so we can run them in Helix later.
  - task: CopyFiles@2
    displayName: 'copy push notifications test binaries'
    condition: and(succeeded(), or(eq(variables['buildPlatform'], 'x86'), eq(variables['buildPlatform'], 'x64')))
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)\BuildOutput\$(buildConfiguration)\$(buildPlatform)'
      Contents: |
        PushNotificationTests\**
      TargetFolder: '$(Build.ArtifactStagingDirectory)\pushnotification_testbin\$(buildPlatform)\$(buildConfiguration)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish push notifications test binaries'
    condition: and(succeeded(), or(eq(variables['buildPlatform'], 'x86'), eq(variables['buildPlatform'], 'x64')))
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\pushnotification_testbin\$(buildPlatform)\$(buildConfiguration)'
      artifactName: pushnotification_test_binaries_$(buildPlatform)_$(buildConfiguration)

  - task: powershell@2
    displayName: 'Copy files to staging dir'
    inputs:
      targetType: filePath
      filePath: build\CopyFilesToStagingDir.ps1
      arguments: -BuildOutputDir '$(buildOutputDir)' -OverrideDir '$(Build.SourcesDirectory)\build\override' -PublishDir '$(Build.ArtifactStagingDirectory)\${{ parameters.artifactName }}' -NugetDir '$(Build.ArtifactStagingDirectory)\FullNuget' -Platform '$(buildPlatform)' -Configuration '$(buildConfiguration)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifact: ${{ parameters.artifactName }}'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\${{ parameters.artifactName }}'
      artifactName: ${{ parameters.artifactName }}

  - task: PublishBuildArtifacts@1
    displayName: 'Publish artifact: Full Nuget (Windows App Runtime DLLs)'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\FullNuget'
      artifactName: FullNuget
