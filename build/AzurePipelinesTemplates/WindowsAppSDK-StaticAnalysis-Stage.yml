parameters:
- name: runStaticAnalysis
  type: boolean
  default: true

stages:
- stage: StaticAnalysis
  dependsOn: Build
  condition: not(failed())
  jobs:
  - job: StaticAnalysis
    variables:
      - name: ob_sdl_apiscan_enabled
        ${{ if parameters.runStaticAnalysis }}:
          value: true
        ${{ else }}:
          value: false
    steps:
    - ${{ if eq(parameters.runStaticAnalysis, 'true') }}:
      - task: SDLNativeRules@3
        displayName: Run PREfast SDL Native Rules
        condition: and(succeeded(), eq(variables['buildConfiguration'], 'Release'), eq(variables['buildPlatform'], 'x64'))
        inputs:
          setupCommandlines: '"C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\Tools\VsMSBuildCmd.bat"'
          msBuildArchitecture: amd64
          msBuildCommandline: 'msbuild.exe /restore /nologo /nr:false /p:configuration=Release /p:platform=x64 $(Build.SourcesDirectory)\WindowsAppRuntime.sln'
          # Generally speaking, we leave it to the external repos to scan the bits in their packages.
          excludedPaths: |
            $(Build.SourcesDirectory)\packages
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        continueOnError: true

      # Copy build output to folder APIScanTarget for APIScan to scan later, in the mean time, exclude some folders/files.
      - task: CopyFiles@2
        displayName: Populate APIScanTarget
        condition: and(succeeded(), eq(variables['ob_sdl_apiscan_enabled'], 'true'))
        inputs:
          SourceFolder: '$(build.SourcesDirectory)\BuildOutput'
          TargetFolder: '$(build.SourcesDirectory)\APIScanTarget'
          # Excluding from APIScan:
          # - arm/arm64 binaries because APIScan does not support them currently.
          # - TAEF binaries: te.*, wex.*.
          # - HelloWorldAdvancedC* - These are test binaries w/o the word "test" in their file paths. We currently depririoritize APIScan for test binaries.
          contents: |
            **
            !**\*test*\**
            !**\*packages*\**
            !**\*Demoapp*\**
            !**\*Demopackage\**
            !**\HelloWorldAdvancedC*\**        
            !**\arm\**        
            !**\arm64\**     
            !**\te.*exe
            !**\te.*dll
            !**\wex.*exe
            !**\wex.*dll
            !**\wttlog.dll
            !**\*.json
            !**\*.msix
            !**\*.png
            !**\*.binlog
            !**\*.cs
            !**\*.cpp
            !**\*.idl
            !**\*.h
        continueOnError: true
