# Universal Windows Platform
# Build a Universal Windows Platform project using Visual Studio.
# Add steps that test and distribute an app, save build artifacts, and more:
# https://aka.ms/yaml

#name: $(BuildDefinitionName)-$(date:yyMM).$(date:dd)$(rev:rrr)
parameters:
  appxPackageDir: '$(build.artifactStagingDirectory)\AppxPackages\\'
  MRTSourcesDirectory: $(Build.SourcesDirectory)\dev\MRTCore
  MRTBinariesDirectory: $(Build.SourcesDirectory)\BuildOutput

steps:
- task: BatchScript@1
  displayName: Set up environment
  inputs:
    filename: '${{ parameters.MRTSourcesDirectory }}\build\init.cmd'
    arguments: /envonly $(buildPlatform)fre
    modifyEnvironment: true

- task: NuGetToolInstaller@1
  displayName: 'Use NuGet 5.6'
  inputs:
    versionSpec: 5.6
  continueOnError: true

# Start restoring packages for C++ projects. The C# ones will be restored by the build task
# NuGetCommand@2
- task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  displayName: 'NuGet restore of core'
  inputs:
    command: 'custom'
    arguments: 'restore ${{ parameters.MRTSourcesDirectory }}\mrt\core\src\packages.config -ConfigFile nuget.config -PackagesDirectory ${{ parameters.MRTSourcesDirectory }}\mrt\packages'

# NuGetCommand@2
- task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  displayName: 'NuGet restore of applicationmodel'
  inputs:
    command: 'custom'
    arguments: 'restore ${{ parameters.MRTSourcesDirectory }}\mrt\microsoft.applicationmodel.resources\src\packages.config -ConfigFile nuget.config -PackagesDirectory ${{ parameters.MRTSourcesDirectory }}\mrt\packages'

# NuGetCommand@2
- task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  displayName: 'NuGet restore of mrmex'
  inputs:
    command: 'custom'
    arguments: 'restore ${{ parameters.MRTSourcesDirectory }}\mrt\mrm\mrmex\packages.config -ConfigFile nuget.config -PackagesDirectory ${{ parameters.MRTSourcesDirectory }}\mrt\packages'

# NuGetCommand@2
- task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  displayName: 'NuGet restore of mrmmin'
  inputs:
    command: 'custom'
    arguments: 'restore ${{ parameters.MRTSourcesDirectory }}\mrt\mrm\mrmmin\packages.config -ConfigFile nuget.config -PackagesDirectory ${{ parameters.MRTSourcesDirectory }}\mrt\packages'

# NuGetCommand@2
- task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  displayName: 'NuGet restore of mrm unittests'
  inputs:
    command: 'custom'
    arguments: 'restore ${{ parameters.MRTSourcesDirectory }}\mrt\mrm\unittests\packages.config -ConfigFile nuget.config -PackagesDirectory ${{ parameters.MRTSourcesDirectory }}\mrt\packages'

#  - task: powershell@2
#    displayName: 'Install the VS build tools'
#    inputs:
#      targetType: filePath
#      filePath: ${{ parameters.MRTSourcesDirectory }}\build\Initialize-InstallMSBuild.ps1
#      arguments: '-installDir ${{ parameters.MRTSourcesDirectory }}\.buildtools -logsDir ${{ parameters.MRTSourcesDirectory }}\msbuild-install-logs'
    
#  - task: BatchScript@1
#    displayName: Add the VS build tools to the path
#    inputs:
#      filename: '${{ parameters.MRTSourcesDirectory }}\build\SetMSBuildVars.cmd'
#      arguments: '${{ parameters.MRTSourcesDirectory }}\.buildtools'
#      modifyEnvironment: true

#  - task: PublishBuildArtifacts@1
#    displayName: 'Publish install logs'
#    condition: Failed()
#    inputs:
#      PathtoPublish: '${{ parameters.MRTSourcesDirectory }}\msbuild-install-logs'
#      artifactName: 'installlogs'

- task: powershell@2
  displayName: 'Installing .NET SDK'
  inputs:
    targetType: filePath
    workingDirectory: ${{ parameters.MRTSourcesDirectory }}\build
    filePath: ${{ parameters.MRTSourcesDirectory }}\build\DownloadDotNetCoreSdk.ps1 

- task: BatchScript@1
  displayName: 'Use .NET SDK'
  inputs:
    filename: '${{ parameters.MRTSourcesDirectory }}\build\SetDotnetVars.cmd'
    arguments: '${{ parameters.MRTSourcesDirectory }}'
    modifyEnvironment: true

- task: powershell@2
  displayName: 'Download .net runtime Windows installer'
  inputs:
    targetType: filePath
    workingDirectory: ${{ parameters.MRTSourcesDirectory }}\build
    filePath: ${{ parameters.MRTSourcesDirectory }}\build\DownloadDotNetRuntimeInstaller.ps1

#  - task: BatchScript@1
#    displayName: 'Debug'
#    inputs:
#      filename: '$(Build.SourcesDirectory)\build\debug-pipeline.cmd'

- task: MSBuild@1
  displayName: 'build MrtCore'
  inputs:
#      msbuildLocationMethod: 'location'
#      msbuildLocation: ${{ parameters.MRTSourcesDirectory }}\.buildtools\MSBuild\Current\Bin\MSBuild.exe
    platform: '$(buildPlatform)'
    solution: '${{ parameters.MRTSourcesDirectory }}\mrt\MrtCore.sln'
    configuration: '$(buildConfiguration)'
    msbuildArguments: '/restore /p:AppxBundlePlatforms="$(buildPlatform)" /p:AppxPackageDir="${{ parameters.appxPackageDir }}" /p:AppxBundle=Always /p:UapAppxPackageBuildMode=StoreUpload /binaryLogger:$(Build.SourcesDirectory)/mrtcore.$(buildPlatform).$(buildConfiguration).binlog'

- task: PublishBuildArtifacts@1
  displayName: 'Publish mrtcore binlog'
  condition: succeededOrFailed()
  inputs:
    PathtoPublish: $(Build.SourcesDirectory)/mrtcore.$(buildPlatform).$(buildConfiguration).binlog
    artifactName: binlogs

# Diagnostics
- powershell: |
    tree /f /a $(Build.SourcesDirectory)\BuildOutput\Release\$(buildPlatform)
  displayName: 'DIAG: dump BuildOutput'

- powershell: |
    tree /f /a $(Build.SourcesDirectory)\packages
  displayName: 'DIAG: dump packages'

- task: CmdLine@1
  displayName: 'DIAG: dump environment variables'
  inputs:
    filename: 'set'

- task: VSTest@2
  displayName: 'test MRT (Managed)'
  condition: and(succeeded(), or(eq(variables['buildPlatform'], 'x86'), eq(variables['buildPlatform'], 'x64')))
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\ManagedTest.build.appxrecipe
    searchFolder: '${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)'
    testRunTitle: 'test MRT $(buildPlatform)'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'

- task: VSTest@2
  displayName: 'test MRT'
  condition: and(succeeded(), or(eq(variables['buildPlatform'], 'x86'), eq(variables['buildPlatform'], 'x64')))
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\*test*.dll
      !**\*TestAdapter.dll
      !**\TE.*.dll
      !**\obj\**
    searchFolder: '${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)'
    testRunTitle: 'test MRT $(buildPlatform)'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'

# This will pull from Nuget.org due to the nuget.config. However, later on we'll want to pull from an internal feed to validate a new package.
# NuGetCommand@2
#- ${{ if eq(parameters.pipelineKind, 'ValidateReunion') }}:
- task: 333b11bd-d341-40d9-afcf-b32d5ce6f23b@2
  displayName: 'NuGet install Microsoft.ProjectReunion'
  inputs:
    command: 'custom'
    arguments: 'install Microsoft.ProjectReunion -Version 0.5.5 -ConfigFile $(Build.SourcesDirectory)\nuget.config -OutputDirectory $(Build.SourcesDirectory)\packagesTemp'
- task: powershell@2
  displayName: 'Get versions of ProjectReunion dependencies'
  inputs:
    targetType: filePath
    filePath: $(Build.SourcesDirectory)\build\GetVersionsOfProjectReunionDependencies.ps1
    arguments: -PackagesRoot $(Build.SourcesDirectory)\packagesTemp -ProjectReunionPackageVersion 0.5.5

- task: CmdLine@1
  displayName: 'Display build machine environment variables'
  inputs:
    filename: 'set'

- powershell: |
    tree /f /a $(Build.SourcesDirectory)\packagesTemp
  displayName: 'DIAG: dump packagesTemp'

# The Nuget contains the FWP packages under: tools/AppX/*.appx
# Rename them to zip so we can extract them.
- script: |
    cd $(Build.SourcesDirectory)\packagesTemp
    for /f %x in ('dir /b /s *.appx') do ren "%x" *.zip
  displayName: 'Rename appx to zip'

# Extract files
- task: ExtractFiles@1
  displayName: 'Extract appx'
  condition: and(succeeded(), or(eq(variables['buildPlatform'], 'x86'), eq(variables['buildPlatform'], 'x64')))
  inputs:
    archiveFilePatterns: '$(Build.SourcesDirectory)\packagesTemp\**\tools\Appx\win10-$(buildPlatform)\*.zip' 
    destinationFolder: $(Build.SourcesDirectory)\temp\ProjectReunionPackage-win10-$(buildPlatform)
    cleanDestinationFolder: true

- powershell: |
    tree /f /a $(Build.SourcesDirectory)\temp\ProjectReunionPackage-win10-$(buildPlatform)
  displayName: 'DIAG: dump packages'

# Replace the existing MRM.dll and pdb from the UnitTest
# Or perhap just set the PATH?
- script: |
    copy /y $(Build.SourcesDirectory)\temp\ProjectReunionPackage-win10-$(buildPlatform)\MRM.dll ${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)\UnitTest
    copy /y $(Build.SourcesDirectory)\temp\ProjectReunionPackage-win10-$(buildPlatform)\MRM.pdb ${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)\UnitTest
  displayName: 'Replace MRM.dll and pdb for UnitTest'

# Run the test again, this time using the DLL from the package.
- task: VSTest@2
  displayName: 'test MRT'
  condition: and(succeeded(), or(eq(variables['buildPlatform'], 'x86'), eq(variables['buildPlatform'], 'x64')))
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\*unittest*.dll
      !**\*TestAdapter.dll
      !**\TE.*.dll
      !**\obj\**
    searchFolder: '${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)'
    testRunTitle: 'test MRT $(buildPlatform)'
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'


- task: ComponentGovernanceComponentDetection@0
  inputs:
    scanType: 'Register'
    verbosity: 'Verbose'
    alertWarningLevel: 'Medium'
    failOnAlert: true

- task: CopyFiles@2
  displayName: 'copy binaries for signing'
  inputs:
    SourceFolder: '${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)'
    Contents: |
      mrm\mrm.dll
      mrm\mrm.lib
      mrm\mrm.pdb
      Microsoft.ApplicationModel.Resources\Microsoft.ApplicationModel.Resources.dll
      Microsoft.ApplicationModel.Resources\Microsoft.ApplicationModel.Resources.pdb
    TargetFolder: '$(Build.ArtifactStagingDirectory)\mrt_raw\lib\$(buildPlatform)'
    flattenFolders: true

- task: CopyFiles@2
  displayName: 'copy projection binaries and symbols for signing'
  condition: and(succeeded(), eq(variables['buildPlatform'], 'x86'))
  inputs:
    SourceFolder: '${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)\Microsoft.ApplicationModel.Resources.Projection'
    Contents: |
      Microsoft.ApplicationModel.Resources.Projection.dll
      Microsoft.ApplicationModel.Resources.Projection.pdb
    TargetFolder: '$(Build.ArtifactStagingDirectory)\mrt_raw\lib\anycpu\net5.0'
    flattenFolders: false

- task: CopyFiles@2
  displayName: 'copy winmd for signing'
  condition: and(succeeded(), eq(variables['buildPlatform'], 'x86'))
  inputs:
    SourceFolder: '${{ parameters.MRTBinariesDirectory }}\Release\$(buildPlatform)\Microsoft.ApplicationModel.Resources'
    Contents: |
      Microsoft.ApplicationModel.Resources.winmd
    TargetFolder: '$(Build.ArtifactStagingDirectory)\mrt_raw\lib\anycpu'
    flattenFolders: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: Binaries'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\mrt_raw'
    ArtifactName: 'mrtcore_binaries'
