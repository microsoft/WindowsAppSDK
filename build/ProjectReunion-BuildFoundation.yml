# This file has been adapted to use as a non-OneBranch PR validation yml in the WindowsAppSDK Foundation repository
# Prior to 1.4, this file was used to build official release builds. This role has been moved to WindowsAppSDK-Foundation-Release.yml

name: $(version)

trigger: none

variables:
- template: WindowsAppSDK-Versions.yml
- template: WindowsAppSDK-CommonVariables.yml
- template: WindowsAppSDK-Foundation-TestConfig.yml@WindowsAppSDKConfig
# If we pass ${{ variables['Build.SourceBranch'] }} directly to ref: below, then in a PR validation pipeline run scenario,
# there will be an error parsing the resources->repositories->repository->WindowsAppSDKAggregatorSourceBranch because 
# the branch Build.SourceBranch does not exist on the Agg repo. Avoid hitting that error by redirecting to the Main branch.
- name: mySourceBranch
  ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
    value: refs/heads/main
  ${{ else }}:
    value: ${{ variables['Build.SourceBranch'] }}

resources:
  repositories:
    - repository: WindowsAppSDKConfig
      type: git
      name: ProjectReunion/WindowsAppSDKConfig
      ref: refs/heads/main
    - repository: WindowsAppSDKAggregator
      type: git
      name: ProjectReunion/WindowsAppSDKAggregator
      ref: ${{ variables['Build.SourceBranch'] }}
    # Depending on the settings of this pipeline run, we will use exactly one of the following two definitions for the Agg repo.
    # Either we reference the Main branch, or the same branch as the branch that this pipeline is currently being run against.
    - repository: WindowsAppSDKAggregatorSourceBranch
      type: git
      name: ProjectReunion/WindowsAppSDKAggregator
      ref: ${{ variables['mySourceBranch'] }}
    - repository: WindowsAppSDKAggregatorMainBranch
      type: git
      name: ProjectReunion/WindowsAppSDKAggregator
      ref: refs/heads/main

stages:
- template: AzurePipelinesTemplates\WindowsAppSDK-BuildInstaller-Stage.yml@self

- template: AzurePipelinesTemplates\WindowsAppSDK-BuildVSIX-Stage.yml@self

- template: AzurePipelinesTemplates\WindowsAppSDK-Build-Stage.yml@self
  parameters:
    SignOutput: false
    IsOneBranch: false

- template: AzurePipelinesTemplates\WindowsAppSDK-Test-Stage.yml@self

- template: AzurePipelinesTemplates\WindowsAppSDK-PackTransportPackage-Stage.yml@self
  parameters:
    SignOutput: false
    PublishPackage: false
    IsOneBranch: false
    BuildMockWindowsAppSDK: false
