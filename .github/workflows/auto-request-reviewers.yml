name: Auto Request Reviewers (Windows App SDK Foundation)

on:
  pull_request:
    types: [opened, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to test with'
        required: true
        type: number

permissions:
  pull-requests: write
  contents: read

jobs:
  assign-reviewers:
    name: Assign Reviewers
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || !github.event.pull_request.draft }}
    
    steps:
      - name: Get PR details
        id: get-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ inputs.pr_number }}"
            echo "Manual test mode for PR #$PR_NUMBER"
            PR_DATA=$(gh api "/repos/${{ github.repository }}/pulls/$PR_NUMBER")
            TARGET_BRANCH=$(echo "$PR_DATA" | jq -r '.base.ref')
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_OUTPUT
          echo "ðŸ” PR #$PR_NUMBER targets: $TARGET_BRANCH"
      
      - name: Set reviewers based on target branch
        id: set-reviewers
        run: |
          TARGET_BRANCH="${{ steps.get-pr.outputs.target_branch }}"
          echo "ðŸŽ¯ Target branch: $TARGET_BRANCH"
          
          # Windows App SDK branch strategy
          case "$TARGET_BRANCH" in
            release/*)
              # Release branches: Shiproom team
              REVIEWERS="Scottj1s,agniuks,kythant,LegendaryBlair"
              TEAM_REVIEWERS=""
              ;;
            *)
              # Other branches: no automatic assignment
              REVIEWERS=""
              TEAM_REVIEWERS=""
              ;;
          esac
          
          echo "reviewers=${REVIEWERS}" >> $GITHUB_OUTPUT
          echo "team_reviewers=${TEAM_REVIEWERS}" >> $GITHUB_OUTPUT
          
          if [ -n "$REVIEWERS" ]; then
            echo "âœ… Will assign: $REVIEWERS"
          else
            echo "â„¹ï¸ No automatic reviewers for this branch"
          fi
      
      - name: Request reviewers
        if: steps.set-reviewers.outputs.reviewers != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEWERS="${{ steps.set-reviewers.outputs.reviewers }}"
          REVIEWERS_ARRAY=$(echo "$REVIEWERS" | jq -R 'split(",") | map(select(length > 0))')
          
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/pulls/${{ steps.get-pr.outputs.pr_number }}/requested_reviewers" \
            --field reviewers="$REVIEWERS_ARRAY"
          
          echo "âœ… Reviewers assigned!"
